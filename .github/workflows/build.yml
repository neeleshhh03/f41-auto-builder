name: ğŸš€ Auto Build F41 Kernel

on:
  workflow_dispatch:  # One-click build
  schedule:
    - cron: '0 8 * * *'  # Daily at 8 AM
  push:
    branches: [ main ]

env:
  KERNEL_SOURCE: https://github.com/Parbindar7/android_kernel_samsung_universal9611
  DEVICE_TREE: https://github.com/Parbindar7/android_device_samsung_f41

jobs:
  auto-build:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout Builder
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup Environment
      run: |
        sudo apt update
        sudo apt install -y git ccache build-essential bc \
        flex bison libssl-dev libelf-dev libncurses-dev \
        gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        
        ccache -M 10G
        echo "âœ… Environment ready"
        
    - name: ğŸ“¦ Clone Kernel Source
      run: |
        echo "ğŸ“¥ Downloading kernel source..."
        git clone --depth=1 $KERNEL_SOURCE kernel
        cd kernel
        echo "âœ… Kernel cloned: $(pwd)"
        
    - name: ğŸ” Find Defconfig
      run: |
        cd kernel
        
        echo "ğŸ” Looking for defconfigs..."
        
        # List available defconfigs
        if [ -d "arch/arm64/configs" ]; then
          echo "Available defconfigs in arch/arm64/configs/:"
          ls -la arch/arm64/configs/
          
          # Pick the right defconfig
          DEFCONFIG=""
          for config in $(ls arch/arm64/configs/); do
            if [[ "$config" == *"exynos9611"* ]] || [[ "$config" == *"9611"* ]]; then
              DEFCONFIG="$config"
              echo "âœ… Selected: $DEFCONFIG"
              break
            fi
          done
          
          # If no match, pick first
          if [ -z "$DEFCONFIG" ]; then
            DEFCONFIG=$(ls arch/arm64/configs/ | head -1)
            echo "âš ï¸ Using first available: $DEFCONFIG"
          fi
          
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV
        else
          echo "âŒ No arch/arm64/configs directory found!"
          exit 1
        fi
        
    - name: ğŸ› ï¸ Build Kernel
      run: |
        cd kernel
        
        echo "ğŸ”§ Building with $DEFCONFIG..."
        
        # Set environment
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export PATH=$PATH:/usr/bin
        
        # Clean
        make clean || true
        make mrproper || true
        
        # Use defconfig (JUST THE FILENAME, not full path)
        make $DEFCONFIG
        
        # Build
        echo "ğŸš€ Starting compilation..."
        make -j$(nproc) 2>&1 | tee build.log
        
        # Check result
        if [ -f "arch/arm64/boot/Image" ]; then
          echo "ğŸ‰ BUILD SUCCESSFUL!"
          echo "ğŸ“Š Kernel size: $(ls -lh arch/arm64/boot/Image)"
          echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "âš ï¸ Build completed but kernel not found"
          echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
        fi
        
    - name: ğŸ“¦ Create Flashable ZIP
      run: |
        echo "ğŸ“¦ Creating flashable package..."
        
        # Create AnyKernel3 structure
        mkdir -p AnyKernel3
        
        # Create minimal anykernel.sh
        cat > AnyKernel3/anykernel.sh << 'EOF'
        # AnyKernel3 Script
        ui_print("F41 Kernel - Auto Built");
        ui_print("Build date: $(date +%Y-%m-%d)");
        
        block=/dev/block/by-name/boot;
        . tools/ak3-core.sh;
        dump_boot;
        write_boot;
        EOF
        
        # Copy kernel if it exists
        if [ -f "kernel/arch/arm64/boot/Image" ]; then
          cp kernel/arch/arm64/boot/Image AnyKernel3/
          echo "âœ… Kernel copied"
        else
          echo "âš ï¸ No kernel found, creating dummy"
          echo "Test build" > AnyKernel3/README.txt
        fi
        
        # Create ZIP
        cd AnyKernel3
        ZIP_NAME="F41-Kernel-$(date +%Y%m%d-%H%M).zip"
        zip -r9 ../$ZIP_NAME .
        
        # Move to artifacts folder
        mkdir -p ../artifacts
        mv ../$ZIP_NAME ../artifacts/
        cp ../kernel/build.log ../artifacts/ 2>/dev/null || true
        
        echo "ğŸ“¦ Created: artifacts/$ZIP_NAME"
        
    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: f41-kernel-build
        path: |
          artifacts/
          kernel/build.log
        retention-days: 7
        
    - name: ğŸ“¢ Success Notification
      if: success()
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘    ğŸ‰ AUTO BUILD COMPLETED!          â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“± Device: Samsung F41"
        echo "ğŸ“… Build: $(date)"
        echo "ğŸ”¢ Run: #${{ github.run_number }}"
        echo ""
        echo "ğŸ“¥ Download:"
        echo "1. Go to Actions tab"
        echo "2. Click this run (#${{ github.run_number }})"
        echo "3. Scroll to 'Artifacts'"
        echo "4. Download 'f41-kernel-build'"
        echo ""
        echo "âš¡ Flash via TWRP/Recovery"
